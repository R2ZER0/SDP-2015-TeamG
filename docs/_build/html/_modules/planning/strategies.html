

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>planning.strategies &mdash; SDP  documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="SDP  documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../index.html" class="fa fa-home"> SDP</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../action.html">Action Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../controller.html">Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../planning.html">Planning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../planning.html#module-planning.collisions">Collisions Utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../planning.html#module-planning.models">Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../planning.html#module-planning.planner">Planner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../planning.html#module-planning.strategies">Strategies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../planning.html#module-planning.utilities">Utilities</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../postprocessing.html">Postprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing.html">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vision.html">Vision</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../vision.html#module-vision.calibrate">Calibrate Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vision.html#module-vision.colors">Colors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vision.html#module-vision.findHSV">Threshold GUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vision.html#module-vision.tools">Vision tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vision.html#module-vision.tracker">Trackers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../vision.html#module-vision.vision">Vision GUI</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">SDP</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>planning.strategies</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for planning.strategies</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">utilities</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>

<div class="viewcode-block" id="Strategy"><a class="viewcode-back" href="../../planning.html#planning.strategies.Strategy">[docs]</a><span class="k">class</span> <span class="nc">Strategy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">PRECISE_BALL_ANGLE_THRESHOLD</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">15.0</span>
    <span class="n">UP</span><span class="p">,</span> <span class="n">DOWN</span> <span class="o">=</span> <span class="s">&#39;UP&#39;</span><span class="p">,</span> <span class="s">&#39;DOWN&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">,</span> <span class="n">states</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world</span> <span class="o">=</span> <span class="n">world</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_state</span>

    <span class="nd">@current_state.setter</span>
<div class="viewcode-block" id="Strategy.current_state"><a class="viewcode-back" href="../../planning.html#planning.strategies.Strategy.current_state">[docs]</a>    <span class="k">def</span> <span class="nf">current_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_state</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">new_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_state</span> <span class="o">=</span> <span class="n">new_state</span>
</div>
<div class="viewcode-block" id="Strategy.reset_current_state"><a class="viewcode-back" href="../../planning.html#planning.strategies.Strategy.reset_current_state">[docs]</a>    <span class="k">def</span> <span class="nf">reset_current_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Strategy.is_last_state"><a class="viewcode-back" href="../../planning.html#planning.strategies.Strategy.is_last_state">[docs]</a>    <span class="k">def</span> <span class="nf">is_last_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_state</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Strategy.generate"><a class="viewcode-back" href="../../planning.html#planning.strategies.Strategy.generate">[docs]</a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">]()</span>
</div></div>
<div class="viewcode-block" id="DefenderPenalty"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderPenalty">[docs]</a><span class="k">class</span> <span class="nc">DefenderPenalty</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>


    <span class="n">DEFEND_GOAL</span> <span class="o">=</span> <span class="s">&#39;DEFEND_GOAL&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">DEFEND_GOAL</span><span class="p">]</span>
    <span class="n">LEFT</span><span class="p">,</span> <span class="n">RIGHT</span> <span class="o">=</span> <span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;right&#39;</span>
    <span class="n">SIDES</span> <span class="o">=</span> <span class="p">[</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">RIGHT</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DefenderPenalty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DEFEND_GOAL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">defend_goal</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">their_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_defender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>


<div class="viewcode-block" id="DefenderPenalty.defend_goal"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderPenalty.defend_goal">[docs]</a>    <span class="k">def</span> <span class="nf">defend_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run around, blocking shots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Predict where they are aiming.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">velocity</span> <span class="o">&gt;</span> <span class="n">BALL_VELOCITY</span><span class="p">:</span>
            <span class="n">predicted_y</span> <span class="o">=</span> <span class="n">predict_y_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="p">,</span> <span class="n">bounce</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">velocity</span> <span class="o">&lt;=</span> <span class="n">BALL_VELOCITY</span> <span class="ow">or</span> <span class="n">predicted_y</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> 
            <span class="n">predicted_y</span> <span class="o">=</span> <span class="n">predict_y_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_attacker</span><span class="p">,</span> <span class="n">bounce</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">predicted_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                                                           <span class="n">predicted_y</span> <span class="o">-</span> <span class="mi">7</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">angle</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">y</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="mi">60</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_pitch</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">60</span><span class="p">])</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="DefenderDefence"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderDefence">[docs]</a><span class="k">class</span> <span class="nc">DefenderDefence</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">DEFEND_GOAL</span> <span class="o">=</span> <span class="s">&#39;UNALIGNED&#39;</span><span class="p">,</span> <span class="s">&#39;DEFEND_GOAL&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">DEFEND_GOAL</span><span class="p">]</span>
    <span class="n">LEFT</span><span class="p">,</span> <span class="n">RIGHT</span> <span class="o">=</span> <span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;right&#39;</span>
    <span class="n">SIDES</span> <span class="o">=</span> <span class="p">[</span><span class="n">LEFT</span><span class="p">,</span> <span class="n">RIGHT</span><span class="p">]</span>

    <span class="n">GOAL_ALIGN_OFFSET</span> <span class="o">=</span> <span class="mi">60</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DefenderDefence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UNALIGNED</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DEFEND_GOAL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">defend_goal</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">our_goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_goal</span>
        <span class="c"># Find the point we want to align to.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_front_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alignment_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_our_side</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">their_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_defender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>

<div class="viewcode-block" id="DefenderDefence.align"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderDefence.align">[docs]</a>    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align yourself with the center of our goal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">goal_front_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">our_goal</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
            <span class="c"># We&#39;re there. Advance the states and formulate next action.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEFEND_GOAL</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">goal_front_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_goal</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DefenderDefence.defend_goal"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderDefence.defend_goal">[docs]</a>    <span class="k">def</span> <span class="nf">defend_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run around, blocking shots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Predict where they are aiming.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">velocity</span> <span class="o">&gt;</span> <span class="n">BALL_VELOCITY</span><span class="p">:</span>
            <span class="n">predicted_y</span> <span class="o">=</span> <span class="n">predict_y_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="p">,</span> <span class="n">bounce</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">velocity</span> <span class="o">&lt;=</span> <span class="n">BALL_VELOCITY</span> <span class="ow">or</span> <span class="n">predicted_y</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> 
            <span class="n">predicted_y</span> <span class="o">=</span> <span class="n">predict_y_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_attacker</span><span class="p">,</span> <span class="n">bounce</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">predicted_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                                                           <span class="n">predicted_y</span> <span class="o">-</span> <span class="mi">7</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">angle</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">y</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="mi">60</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_pitch</span><span class="o">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">60</span><span class="p">])</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DefenderDefence.get_alignment_position"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderDefence.get_alignment_position">[docs]</a>    <span class="k">def</span> <span class="nf">get_alignment_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given the side, find the x coordinate of where we need to align to initially.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">side</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIDES</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_goal</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">GOAL_ALIGN_OFFSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_goal</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">GOAL_ALIGN_OFFSET</span>

</div></div>
<div class="viewcode-block" id="AttackerDefend"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDefend">[docs]</a><span class="k">class</span> <span class="nc">AttackerDefend</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">BLOCK_PASS</span> <span class="o">=</span> <span class="s">&#39;UNALIGNED&#39;</span><span class="p">,</span> <span class="s">&#39;BLOCK_PASS&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">BLOCK_PASS</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttackerDefend</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UNALIGNED</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BLOCK_PASS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_pass</span>
        <span class="p">}</span>

        <span class="n">zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_pitch</span><span class="o">.</span><span class="n">_zones</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">zone</span><span class="p">]</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span>  <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_x</span> <span class="o">+</span> <span class="n">max_x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_y</span> <span class="o">+</span> <span class="n">max_y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_defender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">their_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_defender</span>

<div class="viewcode-block" id="AttackerDefend.align"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDefend.align">[docs]</a>    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Align yourself with the middle of our zone.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
            <span class="c"># We&#39;re there. Advance the states and formulate next action.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">BLOCK_PASS</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerDefend.block_pass"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDefend.block_pass">[docs]</a>    <span class="k">def</span> <span class="nf">block_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">predicted_y</span> <span class="o">=</span> <span class="n">predict_y_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="p">,</span> <span class="n">full_width</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bounce</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">predicted_y</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ideal_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span>
            <span class="n">ideal_y</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">their_attacker</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ideal_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span>
            <span class="n">ideal_y</span> <span class="o">=</span> <span class="n">predicted_y</span> <span class="o">-</span> <span class="mi">7</span>  <span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>

        <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="AttackerCatch"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerCatch">[docs]</a><span class="k">class</span> <span class="nc">AttackerCatch</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="n">PREPARE</span><span class="p">,</span> <span class="n">CATCH</span> <span class="o">=</span> <span class="s">&#39;PREPARE&#39;</span><span class="p">,</span> <span class="s">&#39;CATCH&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">PREPARE</span><span class="p">,</span> <span class="n">CATCH</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttackerCatchStrategy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PREPARE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CATCH</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">catch</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>

<div class="viewcode-block" id="AttackerCatch.prepare"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerCatch.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CATCH</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">catcher</span> <span class="o">==</span> <span class="s">&#39;closed&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">catcher</span> <span class="o">=</span> <span class="s">&#39;open&#39;</span>
            <span class="k">return</span> <span class="n">open_catcher</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AttackerCatch.catch"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerCatch.catch">[docs]</a>    <span class="k">def</span> <span class="nf">catch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ideal_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span>
        <span class="n">ideal_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">y</span>

        <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="AttackerPositionCatch"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerPositionCatch">[docs]</a><span class="k">class</span> <span class="nc">AttackerPositionCatch</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This catching strategy positions the robot in the middle of the zone</span>
<span class="sd">    so that (ideally) it does not need to do anything</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">PREPARE</span><span class="p">,</span> <span class="n">ALIGN</span><span class="p">,</span> <span class="n">ROTATE</span> <span class="o">=</span> <span class="s">&#39;PREPARE&#39;</span><span class="p">,</span> <span class="s">&#39;ALIGN&#39;</span><span class="p">,</span> <span class="s">&#39;ROTATE&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">PREPARE</span><span class="p">,</span> <span class="n">ALIGN</span><span class="p">,</span> <span class="n">ROTATE</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttackerPositionCatch</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PREPARE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALIGN</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ROTATE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_defender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_pitch</span><span class="o">.</span><span class="n">_zones</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">zone</span><span class="p">]</span>
        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span>  <span class="o">=</span> <span class="n">zone</span><span class="o">.</span><span class="n">boundingBox</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_x</span> <span class="o">+</span> <span class="n">max_x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_y</span> <span class="o">+</span> <span class="n">max_y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<div class="viewcode-block" id="AttackerPositionCatch.prepare"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerPositionCatch.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALIGN</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">catcher</span> <span class="o">==</span> <span class="s">&#39;closed&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">catcher</span> <span class="o">=</span> <span class="s">&#39;open&#39;</span>
            <span class="k">return</span> <span class="n">open_catcher</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AttackerPositionCatch.align"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerPositionCatch.align">[docs]</a>    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center_y</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROTATE</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">center_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerPositionCatch.rotate"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerPositionCatch.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Rotate in the center of the zone in order to intercept the pass of the defender.</span>
<span class="sd">        Tries to match the correct angle given the angle of the defender.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">defender_angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">angle</span>
        <span class="n">attacker_angle</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">our_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_our_side</span>
        <span class="k">if</span> <span class="n">our_side</span> <span class="o">==</span> <span class="s">&#39;left&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">defender_angle</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">defender_angle</span> <span class="o">&lt;</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">attacker_angle</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="k">elif</span> <span class="n">defender_angle</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">attacker_angle</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">defender_angle</span> <span class="o">&gt;</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">defender_angle</span> <span class="o">&lt;</span> <span class="n">pi</span><span class="p">:</span>
                <span class="n">attacker_angle</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="k">elif</span> <span class="n">defender_angle</span> <span class="o">&gt;</span> <span class="n">pi</span> <span class="ow">and</span> <span class="n">defender_angle</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">attacker_angle</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="n">attacker_angle</span><span class="p">:</span>
            <span class="c"># Offsets the attacker&#39;s position in the direction of the desired angled in order to calculate the</span>
            <span class="c"># required rotation.</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">attacker_angle</span><span class="p">),</span>
                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">attacker_angle</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="DefenderBouncePass"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderBouncePass">[docs]</a><span class="k">class</span> <span class="nc">DefenderBouncePass</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Once the defender grabs the ball, move to the center of the zone and shoot towards</span>
<span class="sd">    the wall of the center of the opposite attacker zone, in order to reach our_attacker</span>
<span class="sd">    attacker zone.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">POSITION</span><span class="p">,</span> <span class="n">ROTATE</span><span class="p">,</span> <span class="n">SHOOT</span><span class="p">,</span> <span class="n">FINISHED</span> <span class="o">=</span> <span class="s">&#39;POSITION&#39;</span><span class="p">,</span> <span class="s">&#39;ROTATE&#39;</span><span class="p">,</span> <span class="s">&#39;SHOOT&#39;</span><span class="p">,</span> <span class="s">&#39;FINISHED&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">POSITION</span><span class="p">,</span> <span class="n">ROTATE</span><span class="p">,</span> <span class="n">SHOOT</span><span class="p">,</span> <span class="n">FINISHED</span><span class="p">]</span>

    <span class="n">UP</span><span class="p">,</span> <span class="n">DOWN</span> <span class="o">=</span> <span class="s">&#39;UP&#39;</span><span class="p">,</span> <span class="s">&#39;DOWN&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DefenderBouncePass</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="c"># Map states into functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">POSITION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ROTATE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SHOOT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shoot</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">:</span> <span class="n">do_nothing</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_defender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">their_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>

        <span class="c"># Choose a random side to bounce off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># Find the position to shoot from and cache it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shooting_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_shooting_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="p">)</span>

        <span class="c"># Maximum number of turns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laps_left</span> <span class="o">=</span> <span class="mi">4</span>

<div class="viewcode-block" id="DefenderBouncePass.position"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderBouncePass.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Position the robot in the middle close to the goal. Angle does not matter.</span>
<span class="sd">        Executed initially when we&#39;ve grabbed the ball and want to move.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shooting_pos</span>
        <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ideal_y</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROTATE</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DefenderBouncePass.rotate"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderBouncePass.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Once the robot is in position, rotate to one side or the other in order</span>
<span class="sd">        to bounce the ball into the attacker zone. If one side is blocked by their</span>
<span class="sd">        attacker, turn 90 degrees and shoot to the other side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bounce_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bounce_points</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">bounce_points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">point</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bounce_points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">point</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">get_rotation_to_point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">angle_threshold</span><span class="o">=</span><span class="n">pi</span><span class="o">/</span><span class="mi">20</span><span class="p">):</span>
            <span class="c"># if not is_shot_blocked(self.world, self.our_defender, self.world.their_attacker) or \</span>
            <span class="n">their_attacker_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_robot_side</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">their_attacker</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">their_attacker_side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">their_attacker_side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOOT</span>
                <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># self.point = 1 - self.point</span>
                <span class="c"># self.laps_left -= 1</span>
                <span class="c"># x, y = bounce_points[self.point][0], bounce_points[self.point][1]</span>
                <span class="c"># angle = self.our_defender.get_rotation_to_point(x, y)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_our_side</span> <span class="o">==</span> <span class="s">&#39;right&#39;</span><span class="p">:</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">orientation</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FINISHED</span>
                <span class="k">print</span> <span class="s">&#39;orientation&#39;</span><span class="p">,</span> <span class="n">orientation</span>
                <span class="k">return</span> <span class="n">turn_shoot</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DefenderBouncePass.shoot"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderBouncePass.shoot">[docs]</a>    <span class="k">def</span> <span class="nf">shoot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FINISHED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">catcher</span> <span class="o">=</span> <span class="s">&#39;open&#39;</span>
        <span class="k">return</span> <span class="n">kick_ball</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_get_shooting_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrive the coordinates to which we need to move before we set up the pass.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zone_index</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">zone</span>
        <span class="n">zone_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">zones</span><span class="p">[</span><span class="n">zone_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">min_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">y</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_robot_side</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span>
        <span class="k">print</span> <span class="s">&#39;###########&#39;</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
        <span class="k">if</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span>


    <span class="k">def</span> <span class="nf">_get_bounce_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the points in the opponent&#39;s attacker zone where our defender needs to shoot</span>
<span class="sd">        in order to bounce the ball to our attacker zone.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacker_zone</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
        <span class="n">zone_index</span> <span class="o">=</span> <span class="n">attacker_zone</span><span class="p">[</span><span class="n">robot</span><span class="o">.</span><span class="n">zone</span><span class="p">]</span>
        <span class="n">zone_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">zones</span><span class="p">[</span><span class="n">zone_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">bounce_x</span> <span class="o">=</span> <span class="n">min_x</span> <span class="o">+</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">min_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[(</span><span class="n">bounce_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">),</span> <span class="p">(</span><span class="n">bounce_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">)]</span>

</div>
<div class="viewcode-block" id="AttackerGrab"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrab">[docs]</a><span class="k">class</span> <span class="nc">AttackerGrab</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="n">PREPARE</span><span class="p">,</span> <span class="n">GO_TO_BALL</span><span class="p">,</span> <span class="n">GRAB_BALL</span><span class="p">,</span> <span class="n">GRABBED</span> <span class="o">=</span> <span class="s">&#39;PREPARE&#39;</span><span class="p">,</span> <span class="s">&#39;GO_TO_BALL&#39;</span><span class="p">,</span> <span class="s">&#39;GRAB_BALL&#39;</span><span class="p">,</span> <span class="s">&#39;GRABBED&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">PREPARE</span><span class="p">,</span> <span class="n">GO_TO_BALL</span><span class="p">,</span> <span class="n">GRAB_BALL</span><span class="p">,</span> <span class="n">GRABBED</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttackerGrab</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PREPARE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GO_TO_BALL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GRAB_BALL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grab</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GRABBED</span><span class="p">:</span> <span class="n">do_nothing</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>

<div class="viewcode-block" id="AttackerGrab.prepare"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrab.prepare">[docs]</a>    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GO_TO_BALL</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">catcher</span> <span class="o">==</span> <span class="s">&#39;closed&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">catcher</span> <span class="o">=</span> <span class="s">&#39;open&#39;</span>
            <span class="k">return</span> <span class="n">open_catcher</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AttackerGrab.position"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrab.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">can_catch_ball</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GRAB_BALL</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerGrab.grab"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrab.grab">[docs]</a>    <span class="k">def</span> <span class="nf">grab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">has_ball</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GRABBED</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">catcher</span> <span class="o">=</span> <span class="s">&#39;closed&#39;</span>
            <span class="k">return</span> <span class="n">grab_ball</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="DefenderGrab"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderGrab">[docs]</a><span class="k">class</span> <span class="nc">DefenderGrab</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="n">DEFEND</span><span class="p">,</span> <span class="n">GO_TO_BALL</span><span class="p">,</span> <span class="n">GRAB_BALL</span><span class="p">,</span> <span class="n">GRABBED</span> <span class="o">=</span> <span class="s">&#39;DEFEND&#39;</span><span class="p">,</span> <span class="s">&#39;GO_TO_BALL&#39;</span><span class="p">,</span> <span class="s">&#39;GRAB_BALL&#39;</span><span class="p">,</span> <span class="s">&#39;GRABBED&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">DEFEND</span><span class="p">,</span> <span class="n">GO_TO_BALL</span><span class="p">,</span> <span class="n">GRAB_BALL</span><span class="p">,</span> <span class="n">GRABBED</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DefenderGrab</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DEFEND</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">defend</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GO_TO_BALL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GRAB_BALL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grab</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GRABBED</span><span class="p">:</span> <span class="n">do_nothing</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_defender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>

<div class="viewcode-block" id="DefenderGrab.defend"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderGrab.defend">[docs]</a>    <span class="k">def</span> <span class="nf">defend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If the ball is heading towards our goal at high velocity then don&#39;t go directly into</span>
<span class="sd">        grabbing mode once the ball enters our zone. Try to match it&#39;s y-coordinate as fast as possible.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">velocity</span> <span class="o">&gt;</span> <span class="n">BALL_VELOCITY</span><span class="p">:</span>
            <span class="n">predicted_y</span> <span class="o">=</span> <span class="n">predict_y_intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="p">,</span> <span class="n">bounce</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">predicted_y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                                                               <span class="n">predicted_y</span> <span class="o">-</span> <span class="mi">7</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">angle</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GO_TO_BALL</span>
        <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="DefenderGrab.position"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderGrab.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">can_catch_ball</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GRAB_BALL</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DefenderGrab.grab"><a class="viewcode-back" href="../../planning.html#planning.strategies.DefenderGrab.grab">[docs]</a>    <span class="k">def</span> <span class="nf">grab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">has_ball</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ball</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GRABBED</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span><span class="o">.</span><span class="n">catcher</span> <span class="o">=</span> <span class="s">&#39;closed&#39;</span>
            <span class="k">return</span> <span class="n">grab_ball</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="AttackerScoreDynamic"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerScoreDynamic">[docs]</a><span class="k">class</span> <span class="nc">AttackerScoreDynamic</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Goal scoring tactic. Assumes it will be executed when the robot has grabbed the ball.</span>

<span class="sd">    Outline:</span>
<span class="sd">        1) Position the robot closer to the border line.</span>
<span class="sd">        2) Move to aim into one corner of the goal.</span>
<span class="sd">        3) Re-rotate and aim into the other corner</span>
<span class="sd">        4) Shoot</span>

<span class="sd">    Effectivness:</span>
<span class="sd">        * Only effective if their attacker is not standing on the white line</span>
<span class="sd">          close to us. They need to be at least 40px (the side facing us) from</span>
<span class="sd">          the division line between defender and attacker.</span>
<span class="sd">        * If opponent&#39;s grabber is extended we may not get any leavway for scoring.</span>
<span class="sd">          This assumes that they effectively predict direction and optimize for</span>
<span class="sd">          maximum blocking area.</span>

<span class="sd">    Maths:</span>
<span class="sd">        * When the opponent is defending ideally, we have about 15 degrees leaveway to</span>
<span class="sd">          score</span>
<span class="sd">        * Each ~5 pixels away from the ideal position we lose 2 degrees</span>
<span class="sd">            - Imprecision of 15px results in highly unprobable score in CONFUSE1.</span>
<span class="sd">            - Probability of scoring increases in CONFUSE2</span>
<span class="sd">        * Size of their grabber in extended position is not factored in</span>

<span class="sd">    TODO:</span>
<span class="sd">        * Finish implementing</span>
<span class="sd">        * After CONFUSE1, check if we have a clear shot at the goal and shoot</span>
<span class="sd">            - Defender&#39;s velocity should be taken into consideration</span>
<span class="sd">                - if velocity high, we are better off pulling off the CONFUSE2 part</span>
<span class="sd">                - if low, best to try to shoot as opponent&#39;s vision/delay may not pickup the trick</span>
<span class="sd">        * Attempt to pick sides based on their robot velocity as well</span>
<span class="sd">        * Contigency</span>
<span class="sd">            - If both CONFUSE1 and CONFUSE2 fail, we may switch strategies or resort to a shot</span>
<span class="sd">              either UP or DOWN, based on their position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GRABBED</span><span class="p">,</span> <span class="n">POSITION</span> <span class="o">=</span> <span class="s">&#39;GRABBED&#39;</span><span class="p">,</span> <span class="s">&#39;POSITION&#39;</span>
    <span class="n">CONFUSE1</span><span class="p">,</span> <span class="n">CONFUSE2</span><span class="p">,</span> <span class="n">SHOOT</span> <span class="o">=</span> <span class="s">&#39;CONFUSE1&#39;</span><span class="p">,</span> <span class="s">&#39;CONFUSE2&#39;</span><span class="p">,</span> <span class="s">&#39;SHOOT&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">GRABBED</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="n">CONFUSE1</span><span class="p">,</span> <span class="n">CONFUSE2</span><span class="p">,</span> <span class="n">SHOOT</span><span class="p">]</span>

    <span class="n">UP</span><span class="p">,</span> <span class="n">DOWN</span> <span class="o">=</span> <span class="s">&#39;UP&#39;</span><span class="p">,</span> <span class="s">&#39;DOWN&#39;</span>
    <span class="n">GOAL_SIDES</span> <span class="o">=</span> <span class="p">[</span><span class="n">UP</span><span class="p">,</span> <span class="n">DOWN</span><span class="p">]</span>

    <span class="n">SHOOTING_X_OFFSET</span> <span class="o">=</span> <span class="mi">85</span>
    <span class="n">GOAL_CORNER_OFFSET</span> <span class="o">=</span> <span class="mi">55</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttackerScoreDynamic</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>
        <span class="c"># Map states into functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GRABBED</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">POSITION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">confuse_one</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CONFUSE1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">confuse_two</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CONFUSE2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shoot</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SHOOT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shoot</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_defender</span>

        <span class="c"># Find the position to shoot from and cache it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shooting_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_shooting_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">)</span>

        <span class="c"># Remember which side we picked first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fake_shoot_side</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="AttackerScoreDynamic.generate"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerScoreDynamic.generate">[docs]</a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pick an action based on current state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&#39;BALL&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">]()</span>
</div>
<div class="viewcode-block" id="AttackerScoreDynamic.position"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerScoreDynamic.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Position the robot in the middle close to the goal. Angle does not matter.</span>
<span class="sd">        Executed initially when we&#39;ve grabbed the ball and want to move.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shooting_pos</span>
        <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ideal_y</span><span class="p">):</span>
            <span class="c"># We&#39;ve reached the POSITION state.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">POSITION</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">confuse_one</span><span class="p">()</span>

        <span class="c"># We still need to drive</span>
        <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerScoreDynamic.confuse_one"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerScoreDynamic.confuse_one">[docs]</a>    <span class="k">def</span> <span class="nf">confuse_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pick a side and aim at it. Executed when we&#39;ve reached the POSITION state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Initialize fake shoot side if not available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_shoot_side</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fake_shoot_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fake_shoot_side</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="p">)</span>

        <span class="n">target_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">x</span>
        <span class="n">target_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_goal_corner_y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fake_shoot_side</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&#39;SIDE:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_shoot_side</span>

        <span class="k">print</span> <span class="s">&#39;TARGET_Y&#39;</span><span class="p">,</span> <span class="n">target_y</span>
        <span class="k">print</span> <span class="s">&#39;STATE:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span>

        <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&#39;DIRECTION TO POINT&#39;</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span>

        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">):</span>
            <span class="c"># TODO: Shoot if we have a clear shot and the oppononet&#39;s velocity is favourable for us</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="o">.</span><span class="n">y</span>
            <span class="n">middle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="n">opp_robot_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_fake_shoot_side</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opp_robot_side</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fake_shoot_side</span><span class="p">:</span>
                <span class="c"># We&#39;ve finished CONFUSE1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CONFUSE1</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">confuse_two</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c"># Rotate on the spot</span>
        <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerScoreDynamic.confuse_two"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerScoreDynamic.confuse_two">[docs]</a>    <span class="k">def</span> <span class="nf">confuse_two</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rotate to the other side and make them go &#39;Wow, much rotate&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">other_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_other_side</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fake_shoot_side</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;OTHER SIDE:&#39;</span><span class="p">,</span> <span class="n">other_side</span>
        <span class="c"># Determine targets</span>
        <span class="n">target_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">x</span>
        <span class="n">target_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_goal_corner_y</span><span class="p">(</span><span class="n">other_side</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&#39;OTHER SIDE TARGET Y&#39;</span><span class="p">,</span> <span class="n">target_y</span>

        <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_rotation_to_point</span><span class="p">(</span><span class="n">target_x</span><span class="p">,</span> <span class="n">target_y</span><span class="p">)</span>

        <span class="k">print</span> <span class="s">&#39;OTHER SIDE ANGLE:&#39;</span><span class="p">,</span> <span class="n">angle</span>

        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">angle_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">PRECISE_BALL_ANGLE_THRESHOLD</span><span class="p">):</span>
            <span class="c"># We&#39;ve finished CONFUSE2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOOT</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shoot</span><span class="p">()</span>
            <span class="c"># pass</span>
            <span class="k">pass</span>

        <span class="c"># Rotate on the spot</span>
        <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerScoreDynamic.shoot"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerScoreDynamic.shoot">[docs]</a>    <span class="k">def</span> <span class="nf">shoot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOOT</span>
        <span class="k">return</span> <span class="n">kick_ball</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_get_shooting_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrive the coordinates to which we need to move before we set up the confuse shot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zone_index</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">zone</span>
        <span class="n">zone_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">zones</span><span class="p">[</span><span class="n">zone_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Find the x coordinate of where we need to go</span>
        <span class="c"># Find which function to use, min for us on the right, max otherwise</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">max</span> <span class="k">if</span> <span class="n">zone_index</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="nb">min</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c"># Offset x to be a wee bit inside our zone</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOOTING_X_OFFSET</span> <span class="k">if</span> <span class="n">zone_index</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOOTING_X_OFFSET</span>

        <span class="c"># y is simply middle of the pitch</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_fake_shoot_side</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the location of their robot with the middle to pick the first side</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">robot</span><span class="o">.</span><span class="n">y</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">middle</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span>

    <span class="k">def</span> <span class="nf">_get_other_side</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the other side to rotate to based on the CONFUSE1 side.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">side</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">GOAL_SIDES</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span> <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span>

    <span class="k">def</span> <span class="nf">_get_goal_corner_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the coordinates of where to aim / shoot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">side</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">GOAL_SIDES</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span><span class="p">:</span>
            <span class="c"># y coordinate of the goal is DOWN, offset by the width</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GOAL_CORNER_OFFSET</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">GOAL_CORNER_OFFSET</span> <span class="o">+</span> <span class="mi">20</span>

</div>
<div class="viewcode-block" id="AttackerDriveBy"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveBy">[docs]</a><span class="k">class</span> <span class="nc">AttackerDriveBy</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Strategy where we drive forward and backwards, rotate and shoot.</span>

<span class="sd">    Idea:</span>
<span class="sd">        1) Move to a location either in the UP or DOWN section, opposite to</span>
<span class="sd">           the location of the opposite defender</span>
<span class="sd">        2) If path is clear, proceed. Otherwise, switch sides.</span>
<span class="sd">        3) Rotate to face the goal</span>
<span class="sd">        4) Shoot</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DRIVE</span><span class="p">,</span> <span class="n">ALIGN_GOAL</span><span class="p">,</span> <span class="n">SHOOT</span><span class="p">,</span> <span class="n">FINISHED</span> <span class="o">=</span> <span class="s">&#39;DRIVE&#39;</span><span class="p">,</span> <span class="s">&#39;ALIGN_GOAL&#39;</span><span class="p">,</span> <span class="s">&#39;SHOOT&#39;</span><span class="p">,</span> <span class="s">&#39;FINISHED&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">DRIVE</span><span class="p">,</span> <span class="n">ALIGN_GOAL</span><span class="p">,</span> <span class="n">SHOOT</span><span class="p">,</span> <span class="n">FINISHED</span><span class="p">]</span>

    <span class="n">X_OFFSET</span> <span class="o">=</span> <span class="mi">70</span>
    <span class="n">Y_OFFSET</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="n">UP</span><span class="p">,</span> <span class="n">DOWN</span> <span class="o">=</span> <span class="s">&#39;UP&#39;</span><span class="p">,</span> <span class="s">&#39;DOWN&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttackerDriveBy</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DRIVE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALIGN_GOAL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_to_goal</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SHOOT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shoot</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">:</span> <span class="n">do_nothing</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_defender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_goal_points</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pick_side</span><span class="p">()</span>

<div class="viewcode-block" id="AttackerDriveBy.pick_side"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveBy.pick_side">[docs]</a>    <span class="k">def</span> <span class="nf">pick_side</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        At first, choose side opposite to their defender.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">middle_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_defender</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">middle_y</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span>
</div>
<div class="viewcode-block" id="AttackerDriveBy.drive"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveBy.drive">[docs]</a>    <span class="k">def</span> <span class="nf">drive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zone_attack_x_offset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># offset the y</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_OFFSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_OFFSET</span>

        <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALIGN_GOAL</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerDriveBy.align_to_goal"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveBy.align_to_goal">[docs]</a>    <span class="k">def</span> <span class="nf">align_to_goal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">other_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span>
        <span class="n">goal_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">x</span>
        <span class="n">goal_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span><span class="p">]</span>

        <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_rotation_to_point</span><span class="p">(</span><span class="n">goal_x</span><span class="p">,</span> <span class="n">goal_y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">angle_threshold</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">30</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_shot_blocked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="p">):</span>
                <span class="c"># Drive to the other side.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">=</span> <span class="n">other_side</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DRIVE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOOT</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerDriveBy.shoot"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveBy.shoot">[docs]</a>    <span class="k">def</span> <span class="nf">shoot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FINISHED</span>
        <span class="k">return</span> <span class="n">kick_ball</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AttackerDriveBy.get_zone_attack_x"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveBy.get_zone_attack_x">[docs]</a>    <span class="k">def</span> <span class="nf">get_zone_attack_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the border coordinate for our attacker zone and their defender.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="n">zone_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">zones</span><span class="p">[</span><span class="n">attacker</span><span class="o">.</span><span class="n">zone</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">max</span> <span class="k">if</span> <span class="n">attacker</span><span class="o">.</span><span class="n">zone</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="nb">min</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="AttackerDriveBy.get_zone_attack_x_offset"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveBy.get_zone_attack_x_offset">[docs]</a>    <span class="k">def</span> <span class="nf">get_zone_attack_x_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the x coordinate already offset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="n">middle_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zone_attack_x</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">our_attacker</span><span class="o">.</span><span class="n">zone</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">middle_x</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_OFFSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">middle_x</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_OFFSET</span>
        <span class="k">return</span> <span class="n">middle_x</span>
</div>
    <span class="k">def</span> <span class="nf">_get_goal_corner_y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">side</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the coordinates of where to aim / shoot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">side</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">UP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span><span class="p">:</span>
            <span class="c"># y coordinate of the goal is DOWN, offset by the width</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_get_goal_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Get the polygon of their defender&#39;s zone.</span>
        <span class="n">zone_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">zones</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="o">.</span><span class="n">zone</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">goal_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_our_side</span><span class="o">==</span><span class="s">&#39;left&#39;</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">goal_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">goal_points</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_points</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span><span class="p">:</span> <span class="n">goal_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span><span class="p">:</span> <span class="n">goal_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">30</span><span class="p">}</span>

</div>
<div class="viewcode-block" id="AttackerDriveByTurn"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveByTurn">[docs]</a><span class="k">class</span> <span class="nc">AttackerDriveByTurn</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>

    <span class="n">CENTER</span><span class="p">,</span> <span class="n">ROTATE</span><span class="p">,</span> <span class="n">DRIVE</span><span class="p">,</span> <span class="n">SHOOT</span><span class="p">,</span> <span class="n">FINISHED</span> <span class="o">=</span> <span class="s">&#39;CENTER&#39;</span><span class="p">,</span> <span class="s">&#39;ROTATE&#39;</span><span class="p">,</span> <span class="s">&#39;DRIVE&#39;</span><span class="p">,</span> <span class="s">&#39;SHOOT&#39;</span><span class="p">,</span> <span class="s">&#39;FINISHED&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">CENTER</span><span class="p">,</span> <span class="n">ROTATE</span><span class="p">,</span> <span class="n">DRIVE</span><span class="p">,</span> <span class="n">SHOOT</span><span class="p">,</span> <span class="n">FINISHED</span><span class="p">]</span>

    <span class="n">Y_OFFSET</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">UP</span><span class="p">,</span> <span class="n">DOWN</span> <span class="o">=</span> <span class="s">&#39;UP&#39;</span><span class="p">,</span> <span class="s">&#39;DOWN&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttackerDriveByTurn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CENTER</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ROTATE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">DRIVE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SHOOT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">shoot</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">:</span> <span class="n">do_nothing</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_defender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_defender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_y</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_goal_points</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pick_side</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">laps_left</span> <span class="o">=</span> <span class="mi">5</span>

<div class="viewcode-block" id="AttackerDriveByTurn.pick_side"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveByTurn.pick_side">[docs]</a>    <span class="k">def</span> <span class="nf">pick_side</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        At first, choose side opposite to their defender.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">middle_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_defender</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">middle_y</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span>
</div>
<div class="viewcode-block" id="AttackerDriveByTurn.center"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveByTurn.center">[docs]</a>    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_zone_center_x</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
            <span class="c"># We&#39;re there. Advance the states and formulate next action.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">align_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">align_y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROTATE</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_zone_center_x</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerDriveByTurn.rotate"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveByTurn.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">displacement</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">angle_threshold</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">30</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DRIVE</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerDriveByTurn.drive"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveByTurn.drive">[docs]</a>    <span class="k">def</span> <span class="nf">drive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_points</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>

        <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">):</span>
            <span class="k">print</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">laps_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SHOOT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drive_side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">laps_left</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROTATE</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerDriveByTurn.shoot"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerDriveByTurn.shoot">[docs]</a>    <span class="k">def</span> <span class="nf">shoot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Decide the direction of the right angle turn, based on our position and</span>
        <span class="c"># side on the pitch.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_our_side</span> <span class="o">==</span> <span class="s">&#39;right&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FINISHED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">catcher</span> <span class="o">=</span> <span class="s">&#39;open&#39;</span>
        <span class="k">return</span> <span class="n">turn_shoot</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_zone_center_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the border coordinate for our attacker zone and their defender.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="n">zone_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">zones</span><span class="p">[</span><span class="n">attacker</span><span class="o">.</span><span class="n">zone</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">min_x</span> <span class="o">+</span> <span class="n">max_x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_get_goal_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Get the polygon of their defender&#39;s zone.</span>
        <span class="n">zone_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">zones</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="o">.</span><span class="n">zone</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">goal_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_our_side</span><span class="o">==</span><span class="s">&#39;left&#39;</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">goal_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">goal_points</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_points</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span><span class="p">:</span> <span class="n">goal_points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">40</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span><span class="p">:</span> <span class="n">goal_points</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">40</span><span class="p">}</span>

</div>
<div class="viewcode-block" id="AttackerTurnScore"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerTurnScore">[docs]</a><span class="k">class</span> <span class="nc">AttackerTurnScore</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move up and down the opponent&#39;s goal line and suddenly turn 90 degrees and kick if the</span>
<span class="sd">    path is clear.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="n">KICK</span><span class="p">,</span> <span class="n">FINISHED</span> <span class="o">=</span> <span class="s">&#39;UNALIGNED&#39;</span><span class="p">,</span> <span class="s">&#39;POSITION&#39;</span><span class="p">,</span> <span class="s">&#39;KICK&#39;</span><span class="p">,</span> <span class="s">&#39;FINISHED&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">POSITION</span><span class="p">,</span> <span class="n">KICK</span><span class="p">,</span> <span class="n">FINISHED</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttackerTurnScore</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UNALIGNED</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">POSITION</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">KICK</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kick</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FINISHED</span><span class="p">:</span> <span class="n">do_nothing</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">their_goal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_goal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">their_defender</span>

        <span class="c"># Distance that the attacker should keep from its boundary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">60</span>

        <span class="c"># Opponent&#39;s goal edge where our attacker is currently heading.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="AttackerTurnScore.align"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerTurnScore.align">[docs]</a>    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Go to the boundary of the attacker&#39;s zone and align with the center</span>
<span class="sd">        of the goal line.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">ideal_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_alignment_x</span><span class="p">()</span>
        <span class="n">ideal_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">y</span>

        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ideal_y</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">POSITION</span>
            <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerTurnScore.position"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerTurnScore.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Go up an down the goal line waiting for the first opportunity to shoot.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="c"># Check if we have a clear shot</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_attacker_shot_blocked</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_defender</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">20</span> <span class="ow">or</span> \
               <span class="nb">abs</span><span class="p">(</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">20</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">KICK</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kick</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># If our shot is blocked, continue moving up and down the goal line.</span>
            <span class="c"># We want the center of the robot to be inside the goal line.</span>
            <span class="n">goal_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">goal_edges</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">goal_width</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">their_goal</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">goal_width</span> <span class="o">-</span> <span class="mi">10</span><span class="p">]</span>
            <span class="n">ideal_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span>
            <span class="n">ideal_y</span> <span class="o">=</span> <span class="n">goal_edges</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">point</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ideal_y</span><span class="p">):</span>
                <span class="c"># Go to the other goal edge</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">point</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">point</span>
                <span class="n">ideal_y</span> <span class="o">=</span> <span class="n">goal_edges</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">point</span><span class="p">]</span>

            <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">backwards_ok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerTurnScore.kick"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerTurnScore.kick">[docs]</a>    <span class="k">def</span> <span class="nf">kick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Decide the direction of the right angle turn, based on our position and</span>
        <span class="c"># side on the pitch.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">_our_side</span> <span class="o">==</span> <span class="s">&#39;left&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">angle</span> <span class="o">&lt;</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orientation</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FINISHED</span>
        <span class="k">return</span> <span class="n">turn_shoot</span><span class="p">(</span><span class="n">orientation</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_alignment_x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Get the polygon of our attacker&#39;s zone.</span>
        <span class="n">zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">our_attacker</span><span class="o">.</span><span class="n">zone</span>
        <span class="k">assert</span> <span class="n">zone</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">zone_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">zones</span><span class="p">[</span><span class="n">zone</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Choose the appropriate function to determine the borderline of our</span>
        <span class="c"># attacker&#39;s zone facing the opponent&#39;s goal.</span>
        <span class="n">side</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="nb">min</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="nb">max</span><span class="p">}</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">side</span><span class="p">[</span><span class="n">zone</span><span class="p">]</span>

        <span class="c"># Get the x coordinate that our attacker needs to match.</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">boundary_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">zone_poly</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">sign</span><span class="p">[</span><span class="n">zone</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span>
        <span class="k">return</span> <span class="n">boundary_x</span>

</div>
<div class="viewcode-block" id="AttackerGrabCareful"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrabCareful">[docs]</a><span class="k">class</span> <span class="nc">AttackerGrabCareful</span><span class="p">(</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Carefully grabbing the ball when it is located by the wall.</span>

<span class="sd">    Idea:</span>
<span class="sd">        Approach perpendicular to the wall to avoid getting stuck by the wall.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">POSITIONED</span><span class="p">,</span> <span class="n">ALIGNED</span><span class="p">,</span> <span class="n">GRABBED</span> <span class="o">=</span> <span class="s">&#39;UNALIGNED&#39;</span><span class="p">,</span> <span class="s">&#39;POSITIONED&#39;</span><span class="p">,</span> <span class="s">&#39;ALIGNED&#39;</span><span class="p">,</span> <span class="s">&#39;GRABBED&#39;</span>
    <span class="n">STATES</span> <span class="o">=</span> <span class="p">[</span><span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">POSITIONED</span><span class="p">,</span> <span class="n">ALIGNED</span><span class="p">,</span> <span class="n">GRABBED</span><span class="p">]</span>

    <span class="n">BALL_Y_OFFSET</span> <span class="o">=</span> <span class="mi">80</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AttackerGrabCareful</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">world</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">NEXT_ACTION_MAP</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UNALIGNED</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">POSITIONED</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALIGNED</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grab</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">GRABBED</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">finish</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ball_side</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ball_side</span><span class="p">()</span>

<div class="viewcode-block" id="AttackerGrabCareful.position"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrabCareful.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>

        <span class="c"># Find ideal x and y</span>
        <span class="n">ideal_x</span> <span class="o">=</span> <span class="n">ball</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_side</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span><span class="p">:</span>
            <span class="n">ideal_y</span> <span class="o">=</span> <span class="n">ball</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">BALL_Y_OFFSET</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ideal_y</span> <span class="o">=</span> <span class="n">ball</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">BALL_Y_OFFSET</span>

        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ideal_y</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">POSITIONED</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">()</span>

        <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">ideal_x</span><span class="p">,</span> <span class="n">ideal_y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerGrabCareful.align"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrabCareful.align">[docs]</a>    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>

        <span class="k">print</span> <span class="s">&#39;BALL SIDE&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_side</span>

        <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">ball</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ball</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_matched</span><span class="p">(</span><span class="n">our_attacker</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALIGNED</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grab</span><span class="p">()</span>

        <span class="n">motors</span> <span class="o">=</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;MOTORS&#39;</span><span class="p">,</span> <span class="n">motors</span>
        <span class="k">return</span> <span class="n">motors</span>

</div>
<div class="viewcode-block" id="AttackerGrabCareful.grab"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrabCareful.grab">[docs]</a>    <span class="k">def</span> <span class="nf">grab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">our_attacker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">our_attacker</span>
        <span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>

        <span class="k">if</span> <span class="n">our_attacker</span><span class="o">.</span><span class="n">can_catch_ball</span><span class="p">(</span><span class="n">ball</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GRABBED</span>
            <span class="k">return</span> <span class="n">grab_ball</span><span class="p">()</span>

        <span class="n">distance</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">our_attacker</span><span class="o">.</span><span class="n">get_direction_to_point</span><span class="p">(</span><span class="n">ball</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ball</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">calculate_motor_speed</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">careful</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AttackerGrabCareful.finish"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrabCareful.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">do_nothing</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AttackerGrabCareful.get_ball_side"><a class="viewcode-back" href="../../planning.html#planning.strategies.AttackerGrabCareful.get_ball_side">[docs]</a>    <span class="k">def</span> <span class="nf">get_ball_side</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ball</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">ball</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">pitch</span><span class="o">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">ball</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">middle</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">DOWN</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">UP</span></div></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Author.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>